<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>

  Robin  Dupont


  | üíæ DIY Cloud backup

</title>
<meta name="description" content="Robin Dupont personal page
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë®‚Äçüåæ</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/blog/2022/data-backup-dupliciti/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-99307127-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-99307127-2');
</script>




    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

  <!-- Nav Bar -->
  <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
  <div class="container">
    
    <a class="navbar-brand title font-weight-lighter" href="/">
     <span class="font-weight-bold">Robin</span>   Dupont
    </a>
    
    <!-- Navbar Toggle -->
    <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar top-bar"></span>
      <span class="icon-bar middle-bar"></span>
      <span class="icon-bar bottom-bar"></span>
    </button>
    <div class="collapse navbar-collapse text-right" id="navbarNav">
      <ul class="navbar-nav ml-auto flex-nowrap">
        <!-- About -->
        <li class="nav-item ">
          <a class="nav-link" href="/">
            about
            
          </a>
        </li>
        
        <!-- Blog -->
        <li class="nav-item active">
          <a class="nav-link" href="/blog/">
            blog
            
          </a>
        </li>
        
        <!-- Other pages -->
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
          <div class = "toggle-container">
            <a id = "light-toggle">
                <i class="fas fa-moon"></i>
                <i class="fas fa-sun"></i>
            </a>
          </div>
        
      </ul>
    </div>
  </div>
</nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">üíæ DIY Cloud backup</h1>
    <p class="post-meta">October 9, 2022</p>
  </header>

  <article class="post-content">
    <p>Did you know that <a href="https://www.worldbackupday.com/" target="_blank">World Backup Day</a> is on the 31rst of March? Heck, did you even know there was a <strong>World Backup Day</strong>? Indeed backing up your data is important, but what to do?  Starting by having a remote copy of your most important data on services like Google Drive, Dropbox, Onedrive, etc‚Ä¶ is a good start! But what if you want to do it <strong>yourself</strong>? Maybe because you want <strong>better control over your data</strong>, or maybe because you do not want <a href="https://www.nytimes.com/2022/08/21/technology/google-surveillance-toddler-photo.html" target="_blank">Google to shut down your account because of what you have on your Google Drive</a>? Or maybe you just want to do it yourself because you can. In any case, the  general rule of thumb for backing up data is to follow the <strong>3-2-1</strong> rule:</p>
<ul>
  <li><strong>3</strong> copies of your important data</li>
  <li>on <strong>2</strong> different storage mediums</li>
  <li><strong>1</strong> of which is off-site</li>
</ul>

<p>The first two points are quite easy to satisfy. However, the last one (<strong>having a backup off-site</strong>), is a bit more tricky. You either need to be able to access a bit of storage on a friend‚Äôs NAS or set up a second NAS in your family or friend‚Äôs house. Certainly doable, but not the easiest solution since you need to maintain two separate computers, one of which is not easily accessible because it is precisely off-site.</p>

<p>Another way to back up your data off-site is to use a <strong>cloud storage provider</strong> and backup software. I chose to use <a href="https://www.backblaze.com/" target="_blank">BackBlaze</a> as the cloud provider because it is <strong>cheap and easy to use</strong>, even if you never used such services before. For the backup software, I will use <a href="https://www.duplicati.com/" target="_blank">Duplicati</a>. Duplicati is open source and allows for <strong>encrypted and compressed incremental backups</strong>. Incremental backup is an incredibly useful feature: You only backup the files that changed since the last backup. You do not need to back up all your files every time! Ah, and yes, Duplicati is compatible with BackBlaze!</p>

<h1 id="preparing-the-cloud-Ô∏è">Preparing the cloud ‚òÅÔ∏è</h1>

<h3 id="creating-my-first-bucket-">Creating my first bucket ü™£</h3>

<p>Let‚Äôs tackle the cloud part. Data are stored in a <strong>bucket</strong>, which is roughly a top-level folder that will contain all my backup data. To create my bucket I first sing up for an account on BackBlaze. I chose the <strong>EU region</strong> when creating my account because first, I am living in Europe, and then to prevent my data from being stored in the US. I then created a bucket to store my backup data in the ‚Äúbuckets‚Äù section of the ‚ÄúMy Account‚Äù page. Beware that it seems like t<strong>he name should be original among all bucket names on BackBlaze</strong>. To make sure the name was not already taken, I added <strong>4 random characters</strong> at the end of it. I set the bucket to private. It is possible to <strong>enable encryption</strong>, however, it is not necessary since my backup will already be encrypted by Duplicati before being uploaded to BackBlaze.</p>

<div class="row justify-content-sm-center">
    <div class="col-sm-5 mt-4 mt-md-0">
    <figure>

  <picture>
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/blog/data_bckp/account_creation.png" data-zoomable="" />

  </picture><figcaption class="caption">Region selection on BackBlaze</figcaption>

</figure>

    </div>
     <div class="col-sm-4 mt-4 mt-md-0">
    <figure>

  <picture>
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/blog/data_bckp/bucket-creation.png" data-zoomable="" />

  </picture><figcaption class="caption">Bucket Creation on BackBlaze</figcaption>

</figure>

    </div>
</div>

<h3 id="keys-of-the-realm-">Keys of the realm üîë</h3>
<p>To programmatically access your bucket, Duplicati needs <strong>API keys</strong> - here called Application Keys. If you have never heard of it, you can see them as <strong>passwords for applications</strong>. I generated keys just for Duplicati in the ‚ÄúApp Keys‚Äù section. I gave them a friendly name so I will know what they are used for in the future. Then I chose for which bucket they will be valid. It is possible to select all the buckets, but that is always a good practice to <strong>give API keys only the rights they need</strong>, nothing more! Then I chose <code class="language-plaintext highlighter-rouge">Read and Write</code> rights because I want to upload my backups (write), but I also want to retrieve them if needed (read). I left all the other parameters blank.</p>

<p>Once the keys are created they appear in a light blue rectangle (see picture below). I left the <strong>webpage open</strong> until I copied them in Duplicati. If you follow the same process as I do, beware: <strong>the keys only appear once</strong>!</p>

<div class="row justify-content-sm-center">
    <div class="col-sm-4 mt-4 mt-md-0">
    <figure>

  <picture>
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/blog/data_bckp/api-key-creation.png" data-zoomable="" />

  </picture><figcaption class="caption">Application Keys creation</figcaption>

</figure>

    </div>
    <div class="col-sm-5 mt-4 mt-md-0">
    <figure>

  <picture>
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/blog/data_bckp/api-key-visualization.png" data-zoomable="" />

  </picture><figcaption class="caption">Visualisation of the Application Keys</figcaption>

</figure>

    </div>
</div>

<h1 id="duplicati-in-a-container-">Duplicati in a container üê≥</h1>

<h3 id="getting-the-container-ready-">Getting the container ready üß∞</h3>

<p>Once the cloud part is done, I focused on Duplicati itself. For all the services I run at home, I use <strong>Docker</strong>. You can get Docker installation instructions <a href="https://docs.docker.com/engine/install/ubuntu/" target="_blank">here</a>. To keep things simple and readable, I like to use <strong>Docker Compose</strong>. It can be easily installed with a simple command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>docker-compose-plugin
</code></pre></div></div>
<p>This command will install docker compose V2 (more info <a href="https://www.docker.com/blog/announcing-compose-v2-general-availability/" target="_blank">here</a>). Not the V1 pip package <code class="language-plaintext highlighter-rouge">docker-compose</code> (there is a hyphen between <em>docker</em> and <em>compose</em> in this case).</p>

<p>Docker compose is a nice tool that allows <strong>configuring easily docker containers with a text file</strong>, which is always called <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code>. It also provides some useful tools to <strong>recreate</strong> containers and <strong>pull</strong> new images for example.</p>

<p>I started by creating a new folder called <code class="language-plaintext highlighter-rouge">duplicati</code>, and inside this folder, I created a file called, you guessed it, <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code>. Examples of <code class="language-plaintext highlighter-rouge">docker-compose</code> files are often provided on <strong>Docker Hub</strong>. It is the case for  <a href="https://hub.docker.com/r/linuxserver/duplicati" target="_blank">Duplicati</a>.  Here is the file content:</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---
version: "2.1"
services:
  duplicati:
    image: lscr.io/linuxserver/duplicati:latest
    container_name: duplicati
    environment:
      - PUID=0
      - PGID=0
      - TZ=Europe/Paris
    volumes:
      - ./duplicati-config:/config
      - ./local-backups:/backups
      - &lt;path-to-data&gt;:/source
    ports:
      - 8200:8200
    restart: unless-stopped
</code></pre></div></div>
<p>As you can see, I used the <a href="https://www.linuxserver.io/" target="_blank">linuxserver.io</a> image.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">PUID</code> and <code class="language-plaintext highlighter-rouge">PGID</code> are ids for the user that will run Duplicati <strong>inside the container</strong>. Generally speaking, you want to set both of them to <code class="language-plaintext highlighter-rouge">1000</code>, which is the id of the <strong>first created user</strong>. However, I set them to <code class="language-plaintext highlighter-rouge">0</code>, because I want to access files owned by <strong>root</strong>.</li>
  <li><code class="language-plaintext highlighter-rouge">TZ</code> is simply the timezone, to make sure scheduled backups run when you expect them to!
For the volumes, the config will be stored in <code class="language-plaintext highlighter-rouge">duplicati-config</code> and local backups in <code class="language-plaintext highlighter-rouge">local-backups</code>. However since I will use BackBlaze, there should not be any backups stored there. Both folders will be inside the <code class="language-plaintext highlighter-rouge">duplicati</code> folder since I used relative paths.</li>
  <li>The path for the <code class="language-plaintext highlighter-rouge">/source</code> folder should be updated according to your needs. I map it to an external SSD where are located the files I want to backup. It might be tempting to add the flag <code class="language-plaintext highlighter-rouge">ro</code> for <code class="language-plaintext highlighter-rouge">read-only</code>, to make sure Duplicati <strong>does not alter the source files</strong> This will, however, <strong>prevent</strong> Duplicati from <strong>restoring</strong> the files in the <strong>source destination</strong>, and you will have to restore them in another folder (such as <code class="language-plaintext highlighter-rouge">./local-backups</code>).</li>
  <li>I left the port to the default value of <code class="language-plaintext highlighter-rouge">8200</code> in this example, but you can use whatever value suits your needs.</li>
</ul>

<p>Once this file was created I started the container with :</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose up <span class="nt">-d</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">-d</code> option makes sure the container is started in a <strong>detached mode</strong>. I made sure everything was ok by running <code class="language-plaintext highlighter-rouge">docker compose logs -f</code>.</p>

<h3 id="configuration-through-the-web-interface-">Configuration through the web interface üîß</h3>

<p>To reach the web interface, I went to the IP of the computer hosting the docker container, followed by the port, so in the case of this example : <code class="language-plaintext highlighter-rouge">8200</code>.</p>

<p>The web interface is straightforward. I created a new backup. In destination, I choose specifically the <code class="language-plaintext highlighter-rouge">B2 Cloud Storage</code> option. The <strong>bucket name</strong> is the same as the one I just created : <code class="language-plaintext highlighter-rouge">data-backup-ej8c</code>. <strong>Folder path</strong> is the path inside the bucket. I simply add a directory called <code class="language-plaintext highlighter-rouge">backcups</code> at the root of the bucket. and finally I inputed the <code class="language-plaintext highlighter-rouge">keyID</code> (for <code class="language-plaintext highlighter-rouge">B2 Application ID</code>) and <code class="language-plaintext highlighter-rouge">applicationKey</code> (for <code class="language-plaintext highlighter-rouge">B2 Application Key</code>) that were generated on the Backblaze website.</p>

<div class="row justify-content-sm-center">
    <div class="col-sm-8 mt-4 mt-md-0">
    <figure>

  <picture>
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/blog/data_bckp/duplicati-config.png" data-zoomable="" />

  </picture><figcaption class="caption">Backup creation in Duplicati</figcaption>

</figure>

    </div>
</div>

<p>I then followed through with the configuration, by selecting my source file and also specifying the backup schedule.</p>

<p>Once the backup is done, I clicked <em>Run Now</em> to make sure the <strong>first backup</strong> was created and voil√†!</p>

<p>Browsing the files on Backblaze should now show <strong>a bunch of files</strong> all of the same sizes (except for a few with index in the name).</p>

<div class="row justify-content-sm-center">
    <div class="col-sm-8 mt-4 mt-md-0">
    <figure>

  <picture>
    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/blog/data_bckp/backblaze-file-browsing.png" data-zoomable="" />

  </picture><figcaption class="caption">Backup creation in Duplicati</figcaption>

</figure>

    </div>
</div>

<h3 id="updating-duplicati-Ô∏è">Updating Duplicati ‚¨ÜÔ∏è</h3>

<p>Since I used Docker Compose, updating Duplicati is <strong>really simple</strong>. Once in the same folder as the <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> file, I first update the image with :</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose pull
</code></pre></div></div>
<p>and recreate the container with:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose up <span class="nt">-d</span>
</code></pre></div></div>

<h1 id="reliable-backups-Ô∏è">Reliable backups ‚òùÔ∏è</h1>
<p>Backblaze can arguably be regarded as <strong>reliable</strong>. It is to say that I will not lose files hosted there. But what if I <strong>lost the Duplicati container</strong>? Recreating the container can be achieved in a <strong>matter of minutes</strong> from a fresh <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> file. However, I will miss the backup configuration. Fortunately, it is possible to <strong>export</strong> a Duplicati <strong>backup configuration file</strong>. I exported the configuration file <strong>with the passwords</strong> (it is to say with the Backblaze API keys) and safely backed it up on another computer.</p>

<p>‚ö†Ô∏è Bear in mind that if you <strong>encrypted</strong> your backup, the <strong>recovery key will not be exported</strong> in the configuration file and you will have to back it up yourself somewhere. Maybe on your password manager?</p>


  </article>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname  = 'rd-blog';
      var disqus_identifier = '/blog/2022/data-backup-dupliciti';
      var disqus_title      = "üíæ DIY Cloud backup";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">

   2022 Robin  Dupont.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme.

    
    

  </div>
</footer>



  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
